{% extends "base.html" %}

{% block title %}Detalle de venta | AZYCO{% endblock %}

{% block content %}
<div class="page-wrapper">
  <header class="page-header">
    <div>
      <h1 class="page-title">Venta {{ venta["folio"] }}</h1>
      <p class="page-subtitle">Cliente: {{ venta["cliente_nombre"] }}</p>

      {% if venta["nota"] and "Venta rápida" in venta["nota"] %}
        <div class="hint" style="margin-top:4px;">
          <span class="badge badge-venta-rapida">Venta rápida</span>
          Venta generada desde archivo de antigüedad de saldos.
        </div>
      {% endif %}
    </div>
    <a href="{{ url_for('ventas_listado') }}" class="btn-secondary small">
      Volver a mis ventas
    </a>
  </header>

  <div class="card">
    {% if errores and errores|length > 0 %}
      <div class="alert-error">
        <ul>
          {% for e in errores %}
            <li>{{ e }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if mensaje_ok %}
      <div class="alert-ok">
        {{ mensaje_ok }}
      </div>
    {% endif %}

    <p><strong>Monto total:</strong> ${{ "%.2f"|format(venta["monto"]) }} MXN</p>
    <p><strong>Banco / cuenta destino:</strong> {{ venta["banco"] }} — {{ venta["cuenta_alias"] }}</p>
    <p>
      <strong>Estado banco:</strong>
      <span class="badge badge-{{ venta["estado_banco"]|lower }}">
        {{ venta["estado_banco"] }}
      </span>
    </p>
    <p><strong>Creada:</strong> {{ venta["fecha_creacion"] }}</p>
    <p><strong>Último cambio:</strong> {{ venta["fecha_ultimo_cambio"] }}</p>

    {% if ultima_actualizacion %}
      <p class="hint">
        Última actualización de pagos del banco para esta cuenta:
        {{ ultima_actualizacion }}
      </p>
    {% else %}
      <p class="hint">
        Aún no se han importado movimientos de banco para esta cuenta en el sistema.
      </p>
    {% endif %}

    {% if detalle_venta_rapida and detalle_venta_rapida|length > 0 %}
      <hr>
      <h3>Detalle de documentos (venta rápida)</h3>
      <p class="hint">
        Estos son los documentos (facturas / notas) incluidos en esta venta y el monto que se está cobrando por cada uno.
      </p>
      <table class="table">
        <thead>
          <tr>
            <th>Documento</th>
            <th>Neto usado en la venta</th>
            <th>Neto original</th>
          </tr>
        </thead>
        <tbody>
          {% for d in detalle_venta_rapida %}
          <tr>
            <td>{{ d.documento }}</td>
            <td>${{ "%.2f"|format(d.neto_editado) }}</td>
            <td>${{ "%.2f"|format(d.neto_original) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}

    {% if venta["nota"] and "Venta rápida" not in venta["nota"] %}
      <hr>
      <h3>Nota</h3>
      <pre class="hint">{{ venta["nota"] }}</pre>
    {% endif %}

    <hr>
    <h3>Comprobante de pago</h3>

    {% if venta["comprobante_filename"] %}
      <p class="hint">
        Ya existe un comprobante cargado para esta venta.
      </p>
      <p>
        <a
          href="{{ url_for('descargar_comprobante', venta_id=venta['id']) }}"
          class="btn-secondary small"
          target="_blank"
        >
          Ver / descargar comprobante
        </a>
      </p>
    {% else %}
      <p class="hint">
        Aún no hay comprobante cargado para esta venta.
      </p>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="form-vertical" style="max-width:320px; margin-top:8px;">
      <input type="hidden" name="accion" value="subir_comprobante">
      <div class="form-group">
        <label class="field-label" for="comprobante">Adjuntar comprobante (PNG, JPG, PDF)</label>
        <input class="field-input" type="file" id="comprobante" name="comprobante" required>
      </div>
      <button type="submit" class="btn-secondary small">Subir comprobante</button>
    </form>

    {% if venta["estado_banco"] != "PAGADO" %}
      <hr>
      <h3>Validar pago con el cliente</h3>
      <p>
        Si el cliente ya hizo la transferencia, presiona el botón.
        El sistema intentará encontrar el pago en los movimientos importados.
      </p>

      <form method="post">
        <input type="hidden" name="accion" value="cliente_pago">
        <button type="submit" class="btn-primary">
          El cliente dice que ya pagó
        </button>
      </form>
    {% endif %}
  </div>
</div>
{% endblock %}
